<!DOCTYPE html>
<html xmlns="https://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>U.S Airlines On-Time Performance</title>
    <meta name="Resource-type" content="Document" />


    <link rel="stylesheet" type="text/css" href="jquery.fullPage.css" />
   <!--[if IE]>
    <script type="text/javascript">
        var console = { log: function() {} };
    </script>
    <![endif]-->

    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>

    <script src="jquery.fullPage.js"></script>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            $('#wrapper').fullpage({
                sectionsColor: ['#ffffff', '#ffffff', '#f2f2f2', '#ffffff', '#f2f2f2', '#ffffff', '#f2f2f2'],
                navigation: true,
                navigationPosition: 'right',
                navigationTooltips: ['Intro', 'Overview', 'Airlines on Time Performance', 'Complaints', 'About', 'Resources'],
                anchors:['Intro', 'Overview', 'Airlines On Time Performance', 'Complaints', 'About', 'Author']
            });
        });
    </script>
    <style>
        .axis path,
        .axis line {
            fill: none;
            stroke: black;
            shape-rendering: crispEdges;
        }

        .axis text {
            font-family: sans-serif;
            font-size: 11px;
        }
        #section0{
            background-image: url("imgs/airplane.jpeg");
            height: 100%;
            background-position: center;
            background-repeat: no-repeat;
            background-size: cover;

        }
        div.tooltip {
            position: absolute;
            text-align: center;
            width: 100px;
            height: 50px;
            padding: 2px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
        }
        .tooltipPie {                                                        /* NEW */
            background: #eee;                                               /* NEW */
            box-shadow: 0 0 5px #999999;                                    /* NEW */
            color: #333;                                                    /* NEW */
            display: none;                                                  /* NEW */
            font-size: 12px;                                                /* NEW */
            left: 130px;                                                    /* NEW */
            padding: 10px;                                                  /* NEW */
            position: absolute;                                             /* NEW */
            text-align: center;                                             /* NEW */
            top: 95px;                                                      /* NEW */
            width: 80px;                                                    /* NEW */
            z-index: 10;                                                    /* NEW */
        }                                                                 /* NEW */
        .legend {
            font-size: 12px;
        }


    </style>

</head>
<body>


<div id="wrapper">
    <div class="section " id="section0">
        <h1>U.S. Airlines On-Time Performance</h1>
        <p>Data to help you decide which carrier to use for your next trip</p>
    </div>
    <div class="section" id="overview-a">
        <h1> Flight Delay Impacting : (Insert your name here)</h1>
        Have you ever got one of those annoying emails? <br>
        Do you wonder if only I had bought the ticket with x or y airline I wouldn't be stuck here? <br>
        Do you dread those rescheduling lines in the middle of the airport? <br>
        We've all been there!. Here is some information from the FAA for the last 3 available months for you to explore how you could avoid that.<br>
        Also, will there be any problems during your flight: Will your suitcase make it to your destination with you or at all?<br>
        They also collect some information on how many complaints each airline gets.<br>
    </div>
    <div class="section" id="section1">
        <div class="container">
            <div class="row">
                <div class="col">
                    <h1>U.S Airlines on Time Performance</h1>
                </div>

            </div>
            <div class="row">
                <div class="col">
                    <h3>Will your airplane leave on time?</h3>
                    To the right there is a visualization of the percentage of time that each of the major U.S. Airlines is on time. <br>
                    On hover you can see the actual percentage in a tooltip. <br>
                    On Click on one of the bars you can see on the right a graph indicating the percentage for each reason that airline is late. <br>
                </div>
                <div class="col-6" id="on-time-performance">

                    <div class="btn-group" role="group" aria-label="Month Selector">
                        <button type="button" class="btn btn-info" data-selection="Apr-17" onClick="changeSelection(this)">April</button>
                        <button type="button" class="btn btn-warning" data-selection="May-17" onClick="changeSelection(this)">May</button>
                        <button type="button" class="btn btn-warning" data-selection="Jun-17" onClick="changeSelection(this)">June</button>
                    </div>
                </div>

                <div class="col">
                    <div class="card">
                        <div class="card-block">
                            <h3>Reason for delay</h3>
                            <div id="reason-pie">
                                Click on a bar to see something!
                            </div>
                            <b> Airline: </b> <br/>
                            <span id="pie-selected-airline"></span>

                        </div>
                    </div>
                </div>
            </div>
        </div>


    </div>
    <div class="section" id="section2">
        <div class="container">
        <div class="row">
            <div class="col">
                <h1>Airline Complaints</h1>
                <!--<p>And it will animate down to the first section</p>-->
            </div>
            <div class="col" id="complaints-graph">

            </div>

        </div>
        </div>
    </div>
    <div class="section" id="section3">
        <div class="container">
            <div class="row">
                <div class="col">
                    <h1> About this Visualization</h1>
                </div>

            </div>
            <div class="row">
                <div class="col">
                    <h3> Narrative Visualization Method</h3>
                    This project was created using the hybrid visualization structure of interactive slideshow.
                    Guidance is provided on each slide. Users can investigate further on each slide or continue to the following one.
                    <h3> Scenes</h3>
                    This project was created as slides using FullPage.js library. The first scene has two charts related to each other. Related to the percentage of on time flights for the U.S airlines and the reasons why they are late.

                    <h3> Annotations</h3>
                    The bar graph has labels on the axis and the pie chart has labels in the middle indicating what each color represents.
                    Other annotations indicate what data is available to explore.
                </div>

                <div class="col">
                    <h3> Parameters</h3>
                    In the on time performance graph the parameter is the month for which the data is displayed that can be selected by clicking on the buttons below the graph.
                    There is an intuitive side bar which allows users to navigate between the different slides. Each slide is represented by a circle. And there is a slightly bigger circle representing the current slide.
                    On hover on each circle there is a tooltip with the name of each slide. Users can navigate either scrolling up and down or by clicking on one of this circles.
                    <h3> Triggers </h3>
                    In the on time performance graph there is an on hover event that triggers a tooltip with the actual value of on time performance.
                    On Click of a bar, a pie chart is displayed on the right displaying the reasons for delay on that airline.
                </div>
            </div>
        </div>
    </div>
    <div class="section" id="section4">
        <div class="container">
            <div class="row">
                <div class="col">
                    <h1> About the Author</h1>
                    This project was created by <a href="https://www.linkedin.com/in/indiragp/">Indira Gutierrez-Polo</a>
                </div>
                <div class="col">
                    <h1> Resources </h1>
                    <ul>
                        <li><a href="https://github.com/alvarotrigo/fullPage.js/">fullPage.js</a></li>
                        <li><a href="https://v4-alpha.getbootstrap.com/">Bootstrap.js</a></li>
                        <li><a href="https://www.transportation.gov/airconsumer/">Dataset</a></li>
                        <!--<li><a href=""></a></li>-->
                        <!--<li><a href=""></a></li>-->

                    </ul>
                </div>
            </div>
        </div>

    </div>
</div>
<script src="//d3js.org/d3.v3.min.js"></script>

<script>

    var margin = {top: 20, right: 20, bottom: 150, left: 40},
        width = 500 - margin.left - margin.right,
        height = 500 - margin.top - margin.bottom;

    // Parse the date / time
    var	parseDate = d3.time.format("%Y-%m").parse;

    var x = d3.scale.ordinal().rangeRoundBands([0, width], .05);

    var y = d3.scale.linear().range([height, 0]);


    var xAxis = d3.svg.axis()
        .scale(x)
        .orient("bottom");
        //.tickFormat(d3.time.format("%Y-%m"));

    var yAxis = d3.svg.axis()
        .scale(y)
        .orient("left")
        .ticks(10);

    var svg = d3.select("#on-time-performance").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("id", "barchart")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
    var selectedDate = "Apr-17";
    var axisExist = false;
    var pieExist  = false;
    bars(selectedDate);


    // Define the div for the tooltip
    var div = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

    function changeSelection(theButton) {
        $('#reason-pie').html("Click on a bar to see something! ");
        $('#pie-selected-airline').html("");
        $('.btn-info').addClass('btn-warning');
        $('.btn-info').removeClass('btn-info');
        $(theButton).removeClass('btn-warning');
        $(theButton).addClass('btn-info');
        var selectedDate = theButton.dataset.selection;
        bars(selectedDate);
    }

    // Ref: http://bl.ocks.org/enjalot/1429426
    function bars(selectedDate){
        d3.csv("data.csv", function(error, data) {

            data = data.filter( function(row) {
                return row['Date'] == selectedDate;
            });
            data.forEach(function(d) {
                d.date = parseDate(d['Date']);
                d.value = +d.P_ONTIME * 100;//% ONTIME
            });


            x.domain(data.map(function(d) { return d['CARRIER']; }));
            y.domain([0, d3.max(data, function(d) { return d.value; })]);

            var vis = d3.select("#barchart");
            var padding = 5;
            // now add titles to the axes
            vis.append("text")
                .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
                .attr("transform", "translate("+ -25 +","+(height/2)+")rotate(-90)")  // text is drawn off the screen top left, move down and out and rotate
                .text("On Time Percentage");

            vis.append("text")
                .attr("text-anchor", "middle")  // this makes it easy to centre the text as the transform is applied to the anchor
                .attr("transform", "translate("+ (width/2) +","+(height+100)+")")  // centre below axis
                .text("Airline");


            //a good written tutorial of d3 selections coming from protovis
            //http://www.jeromecukier.net/blog/2011/08/09/d3-adding-stuff-and-oh-understanding-selections/
            var bars = vis.selectAll("rect.bar")
                .data(data);

            //enter
            bars.enter()
                .append("svg:rect")
                .attr("class", "bar")
                .attr("fill", "#800");


            //exit
            bars.exit()
                .transition()
                .duration(300)
                .ease("exp")
                .attr("width", 0)
                .remove();


            bars
                .attr("stroke-width", 4)
                .transition()
                .duration(300)
                .ease("quad")
                .style("fill", "steelblue")
                .attr("x", function(d) { return x(d['CARRIER']); })
                .attr("width", x.rangeBand())
                .attr("y", function(d) { return y(d.value); })
                .attr("height", function(d) { return height - y(d.value); });

            if(axisExist) {
                bars.select(".x.axis") // change the x axis
                    .duration(750)
                    .call(xAxis);
                bars.select(".y.axis") // change the y axis
                    .duration(750)
                    .call(yAxis);
            } else {
                svg.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0," + height + ")")
                    .call(xAxis)
                    .selectAll("text")
                    .style("text-anchor", "end")
                    .attr("dx", "-.8em")
                    .attr("dy", "-.55em")
                    .attr("transform", "rotate(-90)" );

                svg.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .append("text")
                    .attr("transform", "rotate(-90)")
                    .attr("y", 6)
                    .attr("dy", ".71em")
                    .style("text-anchor", "end");
//                    .text("Value ($)");
                axisExist = true;

            }

        bars.on("mouseover", function(d) {
                div.transition()
                    .duration(200)
                    .style("opacity", .9);
                div	.html( "On time percentage: <br>"+ Math.round(d.value*100)/100 +"%")
                    .style("left", (d3.event.pageX) + "px")
                    .style("top", (d3.event.pageY - 28) + "px");
            })
                .on("mouseout", function(d) {
                    div.transition()
                        .duration(500)
                        .style("opacity", 0);
                })
            .on("click", function(d) {createPieChart(d)});

        });



    }

    function arcTween(a) {
        var i = d3.interpolate(this._current, a);
        this._current = i(0);
        return function(t) {
            return arc(i(t));
        };
    }

    var pie;
    var path;
    //https://bl.ocks.org/mbostock/1346410
    function createPieChart(data) {
        console.log(data);

        $('#pie-selected-airline').text(data["CARRIER"]);
//        var labels = ["AIR CARRIER DELAY", "CANCELLED", "DIVERTED", "EXTREME WEATHER DELAY",
//            "LATE ARRIVING AIRCRAFT DELAY", "NATIONAL AVIATION SYSTEM DELAY"];
//        var dataToDisplay = [,
//        , , ];

        var sum = parseInt(data["AIR CARRIER DELAY"]) +
            parseInt(data["CANCELLED"]) +
            parseInt(data["DIVERTED"]) +
            parseInt(data["EXTREME WEATHER DELAY"]) +
            parseInt(data["LATE ARRIVING AIRCRAFT DELAY"]) +
            parseInt(data["NATIONAL AVIATION SYSTEM DELAY"]);

        var newData = [
            {"label": "AIR CARRIER", "value": 1.0 * parseInt(data["AIR CARRIER DELAY"])/sum, "count": parseInt(data["AIR CARRIER DELAY"])  },
            {"label": "CANCELLED", "value":  1.0 * parseInt(data["CANCELLED"])/sum, "count": parseInt(data["CANCELLED"])},
            {"label": "DIVERTED", "value":  1.0 * parseInt(data["DIVERTED"])/ sum, "count": parseInt(data["DIVERTED"])},
            {"label": "EXTREME WEATHER", "value": 1.0 * parseInt(data["EXTREME WEATHER DELAY"])/ sum, "count": parseInt(data["EXTREME WEATHER DELAY"])},
            {"label": "LATE AIRCRAFT", "value": 1.0 * parseInt(data["LATE ARRIVING AIRCRAFT DELAY"])/ sum, "count": parseInt(data["LATE ARRIVING AIRCRAFT DELAY"])},
            {"label": "NATIONAL AVIATION", "value": 1.0 * parseInt(data["NATIONAL AVIATION SYSTEM DELAY"]) / sum, "count":parseInt(data["NATIONAL AVIATION SYSTEM DELAY"]) }
        ];

        var w = 300;
        var h = 300;
        var r = h/2;
        var color = d3.scale.category20();
        $('#reason-pie').html("");
        var tooltipPie = d3.select('#reason-pie')                               // NEW
            .append('div')                                                // NEW
            .attr('class', 'tooltipPie');

        tooltipPie.append('div')                                           // NEW
            .attr('class', 'label');                                      // NEW

        tooltipPie.append('div')                                           // NEW
            .attr('class', 'count');                                      // NEW

        tooltipPie.append('div')                                           // NEW
            .attr('class', 'percent');

//        if(!pieExist) {
            var vis = d3.select('#reason-pie').append("svg:svg")
                .data([newData])
                .attr("width", w)
                .attr("height", h)
                .append("svg:g")
                .attr("transform", "translate(" + r + "," + r + ")")
                .each(function(d) { this._current = d; });
            pie = d3.layout.pie().value(function(d){return d.value;});

            // Declare an arc generator function
            var arc = d3.svg.arc().outerRadius(r).innerRadius(r-50);

            // Select paths, use arc generator to draw
            var arcs = vis.selectAll("g.slice").data(pie).enter().append("svg:g").attr("class", "slice");
            path = arcs.append("svg:path")
                .attr("fill", function(d, i){return color(i);})
                .attr("d", function (d) {return arc(d);})
            ;
            //https://bl.ocks.org/cflavs/ff1c6005fd7edad32641
            path.on('mouseover', function(d) {                            // NEW
//                var total = d3.sum(dataset.map(function(d) {                // NEW
//                    return d.count;                                           // NEW
//                }));                                                        // NEW
//                var percent = Math.round(1000 * d.data.count / total) / 10; // NEW
                tooltipPie.select('.label').html(d.data.label);                // NEW
                tooltipPie.select('.count').html(d.data.count);                // NEW
                tooltipPie.select('.percent').html(Math.round(d.data.value * 10000)/100 + '%');             // NEW
                tooltipPie.style('display', 'block');                          // NEW
                console.log("bla");
            });                                                           // NEW

            path.on('mouseout', function() {                              // NEW
                tooltipPie.style('display', 'none');                           // NEW
            });

            // Add the text
            arcs.append("svg:text")
                .attr("transform", function(d){
                    d.innerRadius = 50; /* Distance of label to the center*/
                    d.outerRadius = r;
                    return "translate(" + arc.centroid(d) + ")";}
                )
//                .attr("text-anchor", "middle")
//                .text( function(d, i) {return Math.round(newData[i].value * 10000)/100 + '%';})
            ;
            pieExist = true;
        var legendRectSize = 18;
        var legendSpacing = 4;
        var legend = vis.selectAll('.legend')
            .data(color.domain())
            .enter()
            .append('g')
            .attr('class', 'legend')
            .attr('transform', function(d, i) {
                var height = legendRectSize + legendSpacing;
                var offset =  height * color.domain().length / 2;
                var horz = -3 * legendRectSize;
                var vert = i * height - offset;
                return 'translate(' + horz + ',' + vert + ')';
            });

        legend.append('rect')
            .attr('width', legendRectSize)
            .attr('height', legendRectSize)
            .style('fill', color)
            .style('stroke', color);

        legend.append('text')
            .attr('x', legendRectSize + legendSpacing)
            .attr('y', legendRectSize - legendSpacing)
            .text(function(d, i) { return newData[i].label; });

//        } else {
//
//            pie = d3.layout.pie().value(function(d, i){return newData[i].value;});// change the value function
//            path = path.data(pie); // compute the new angles
//            path.transition().duration(750).attrTween("d", arcTween); // redraw the arcs
//
//        }




    }


</script>
</body>
</html>
